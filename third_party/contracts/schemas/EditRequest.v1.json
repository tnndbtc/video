{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "edl-v1-schema",
  "title": "EDL v1 Schema",
  "description": "JSON Schema for EditRequest v1 - User-authored JSON schema for video editing",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0",
      "default": "1.0",
      "description": "Schema version"
    },
    "project_id": {
      "oneOf": [
        { "type": "string", "pattern": "^[A-Za-z0-9._:-]{1,128}$" },
        { "type": "null" }
      ],
      "default": null,
      "description": "Optional project identifier (UUID or simple ID, max 128 chars)"
    },
    "output": {
      "$ref": "#/$defs/OutputSettings"
    },
    "audio": {
      "oneOf": [
        { "$ref": "#/$defs/AudioSettings" },
        { "type": "null" }
      ],
      "default": null
    },
    "defaults": {
      "$ref": "#/$defs/DefaultSettings"
    },
    "timeline": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/TimelineSegment"
      },
      "minItems": 1,
      "description": "List of timeline segments"
    },
    "repeat": {
      "$ref": "#/$defs/RepeatSettings"
    }
  },
  "required": ["version", "timeline"],
  "additionalProperties": true,
  "$defs": {
    "OutputSettings": {
      "type": "object",
      "description": "Output video settings",
      "properties": {
        "width": {
          "type": "integer",
          "minimum": 320,
          "maximum": 7680,
          "default": 1920,
          "description": "Output width in pixels"
        },
        "height": {
          "type": "integer",
          "minimum": 240,
          "maximum": 4320,
          "default": 1080,
          "description": "Output height in pixels"
        },
        "fps": {
          "type": "integer",
          "minimum": 15,
          "maximum": 120,
          "default": 30,
          "description": "Frames per second"
        }
      },
      "additionalProperties": true
    },
    "AudioSettings": {
      "type": "object",
      "description": "Audio track settings",
      "properties": {
        "asset_id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9._:-]{1,128}$",
          "description": "Identifier of the audio asset (UUID or simple ID, max 128 chars)"
        },
        "bpm": {
          "type": ["number", "null"],
          "exclusiveMinimum": 0,
          "maximum": 300,
          "default": null,
          "description": "Override BPM (uses analyzed BPM if not set)"
        },
        "start_offset_ms": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Audio start offset in milliseconds"
        },
        "end_at_audio_end": {
          "type": "boolean",
          "default": true,
          "description": "End video when audio ends. Takes precedence over trim_end_ms when true; if false, trim_end_ms is used to determine the audio end point."
        },
        "trim_end_ms": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Trim from end of audio in milliseconds. Only effective when end_at_audio_end is false."
        }
      },
      "required": ["asset_id"],
      "additionalProperties": true
    },
    "DefaultSettings": {
      "type": "object",
      "description": "Default settings applied to all segments unless overridden",
      "properties": {
        "beats_per_cut": {
          "type": "integer",
          "minimum": 1,
          "maximum": 64,
          "default": 8,
          "description": "Default beats between cuts"
        },
        "transition": {
          "$ref": "#/$defs/Transition"
        },
        "effect": {
          "oneOf": [
            { "$ref": "#/$defs/EffectPreset" },
            { "type": "null" }
          ],
          "default": null,
          "description": "Default motion effect preset"
        }
      },
      "additionalProperties": true
    },
    "RepeatSettings": {
      "type": "object",
      "description": "Settings for handling timeline shorter than audio",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["repeat_all", "repeat_last", "stop"],
          "default": "repeat_all",
          "description": "How to handle repeating timeline"
        },
        "fill_behavior": {
          "type": "string",
          "enum": ["black", "freeze_last"],
          "default": "black",
          "description": "Fill behavior when mode=stop"
        }
      },
      "additionalProperties": true
    },
    "TimelineSegment": {
      "type": "object",
      "description": "Individual segment in the timeline",
      "properties": {
        "asset_id": {
          "type": "string",
          "pattern": "^[A-Za-z0-9._:-]{1,128}$",
          "description": "Identifier of the media asset (UUID or simple ID, max 128 chars)"
        },
        "type": {
          "type": "string",
          "enum": ["image", "video"],
          "description": "Type of media asset"
        },
        "duration": {
          "oneOf": [
            { "$ref": "#/$defs/DurationBeats" },
            { "$ref": "#/$defs/DurationMs" },
            { "$ref": "#/$defs/DurationNatural" },
            { "type": "null" }
          ],
          "default": null,
          "description": "Segment duration. When null or omitted, uses defaults.beats_per_cut (in beats mode) to calculate duration."
        },
        "effect": {
          "oneOf": [
            { "$ref": "#/$defs/EffectPreset" },
            { "type": "null" }
          ],
          "default": null,
          "description": "Motion effect preset"
        },
        "transition_in": {
          "oneOf": [
            { "$ref": "#/$defs/Transition" },
            { "type": "null" }
          ],
          "default": null,
          "description": "Transition at start of segment"
        },
        "source": {
          "oneOf": [
            { "$ref": "#/$defs/SourceTrim" },
            { "type": "null" }
          ],
          "default": null,
          "description": "Video source trim settings (video only)"
        }
      },
      "required": ["asset_id", "type"],
      "additionalProperties": true,
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "image" } },
            "required": ["type"]
          },
          "then": {
            "properties": { "source": { "type": "null" } }
          }
        }
      ]
    },
    "DurationBeats": {
      "type": "object",
      "description": "Duration specified in musical beats",
      "properties": {
        "mode": {
          "type": "string",
          "const": "beats"
        },
        "count": {
          "type": "integer",
          "minimum": 1,
          "maximum": 64,
          "description": "Number of beats (1-64)"
        }
      },
      "required": ["mode", "count"],
      "additionalProperties": false
    },
    "DurationMs": {
      "type": "object",
      "description": "Duration specified in explicit milliseconds",
      "properties": {
        "mode": {
          "type": "string",
          "const": "ms"
        },
        "value": {
          "type": "integer",
          "minimum": 250,
          "maximum": 60000,
          "description": "Duration in milliseconds (250-60000)"
        }
      },
      "required": ["mode", "value"],
      "additionalProperties": false
    },
    "DurationNatural": {
      "type": "object",
      "description": "Natural duration based on asset type",
      "properties": {
        "mode": {
          "type": "string",
          "const": "natural"
        }
      },
      "required": ["mode"],
      "additionalProperties": false
    },
    "Transition": {
      "type": "object",
      "description": "Transition settings between segments. For 'cut' transitions, duration_ms must be 0. For 'crossfade' transitions, duration_ms must be >= 50ms.",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["cut", "crossfade"],
          "default": "cut",
          "description": "Transition type"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "maximum": 2000,
          "default": 0,
          "description": "Transition duration in milliseconds (0-2000). Must be 0 for 'cut', >= 50 for 'crossfade'."
        }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "cut" } } },
          "then": { "properties": { "duration_ms": { "const": 0 } } }
        },
        {
          "if": { "properties": { "type": { "const": "crossfade" } } },
          "then": { "properties": { "duration_ms": { "minimum": 50 } } }
        }
      ],
      "additionalProperties": true
    },
    "SourceTrim": {
      "type": "object",
      "description": "Video source trimming settings",
      "properties": {
        "in_ms": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Start time in source video (milliseconds)"
        },
        "out_ms": {
          "oneOf": [
            {
              "type": "integer",
              "minimum": 0
            },
            { "type": "null" }
          ],
          "default": null,
          "description": "End time in source video (milliseconds, null = end of video)"
        }
      },
      "additionalProperties": true
    },
    "EffectPreset": {
      "type": "string",
      "enum": [
        "slow_zoom_in",
        "slow_zoom_out",
        "pan_left",
        "pan_right",
        "diagonal_push",
        "subtle_drift",
        "none"
      ],
      "description": "Motion effect preset"
    }
  }
}
